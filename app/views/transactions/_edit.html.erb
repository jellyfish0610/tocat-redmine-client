<% if params[:transaction].present?
    total = params[:transaction][:total]
    user_id = params[:transaction][:user_id]
  else
    total = 0
    user_id = 0
  end %>
  <% users = TocatUser.find(:all, params: {limit: 99999})%>

<%= labelled_form_for @transaction, url: transactions_path,
                                :html => {:id => 'inovice-form',
                                          :multipart => true} do |f| %>
    <%= error_messages_for @transaction %>

    <div class="box">
      <fieldset class="tabular">
        <legend><%= l(:label_new_transaction) %></legend>
        <div id="all_attributes">
          <%= labelled_fields_for :transaction, @transaction do |f| %>
            <p>
              <%= f.text_field :comment, :size => 80,
                               :maxlength => 255, :required => true, :value => 'Paid in cash/bank', :disabled => true %>
            </p>
            <%= f.hidden_field :comment, :value => 'Paid in cash/bank'%>
            <p><%= f.select :user_id, options_for_select( users.collect {|t| [t.name, t.id]}, selected: user_id), {:required => true} %></p>
            <p><%= f.select :account_type, options_for_select([[l(:label_balance_type), 'balance'], [l(:label_payment_type), 'payment']], selected: 'payment'), { required: true }, :disabled => true %></p>
            <p><%= f.number_field :total, :class => 'total', :max => 0, :min => -users.first.income_account_state, :required => true, :value => total %></p>

          <% end %>
        </div>
      </fieldset>
    </div>
    <%= submit_tag l(:button_submit) %>
    | <%= link_to l(:button_cancel), {},
                    :onclick => "jQuery.noConflict()('#update').hide(); return false;" %>
<% end %>
<% users_data = {}
   users.collect{|t| users_data[t.id] = -t.income_account_state}
  users_data = users_data.to_json
%>
<%= hidden_field_tag 'users', users_data.as_json %>

<script src="//code.jquery.com/jquery-1.11.2.min.js"></script>
<script charset="utf-8">jQuery.noConflict();</script>
<script charset="utf-8">
jQuery.noConflict()( document ).ready(function() {

});

jQuery.noConflict()(function(){
  var users = JSON.parse(jQuery.noConflict()('#users').val())
  jQuery.noConflict()('#transaction_user_id').on('change', function() {
    jQuery.noConflict()("#transaction_total").prop('max',users[this.value]);
  });
})
</script>
